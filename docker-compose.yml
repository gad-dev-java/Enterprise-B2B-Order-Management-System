services:
  postgres-b2b:
    image: postgres:17-alpine
    container_name: b2b-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: gad-dev
      POSTGRES_PASSWORD: 123456789
    ports:
      - "5432:5432"
    volumes:
      - ./infra/postgres/init-scripts:/docker-entrypoint-initdb.d
      - postgres_data_b2b:/var/lib/postgresql/data
    networks:
      - b2b-network

  mongodb-b2b:
    image: mongo:8.0
    container_name: b2b-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: gad-dev
      MONGO_INITDB_ROOT_PASSWORD: 123456789
      MONGO_INITDB_DATABASE: batch_service_db
    ports:
      - "27017:27017"
    volumes:
      - mongo_data_b2b:/data/db
      - ./infra/mongodb/init-scripts:/docker-entrypoint-initdb.d
    networks:
      - b2b-network

  keycloak-b2b:
    image: quay.io/keycloak/keycloak:26.4.7
    container_name: b2b-keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://b2b-postgres:5432/keycloak_db
      KC_DB_USERNAME: gad-dev
      KC_DB_PASSWORD: 123456789
      KC_HOSTNAME: localhost
    depends_on:
        - postgres-b2b
    ports:
      - "8180:8080"
    networks:
      - b2b-network

  vault-b2b:
    image: hashicorp/vault:1.19.0
    container_name: b2b-vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ROOT-TOKEN-DEV
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    command: server -dev
    networks:
      - b2b-network

  vault-init:
    image: hashicorp/vault:1.19.0
    container_name: b2b-vault-init
    depends_on:
      - vault-b2b
    environment:
      VAULT_ADDR: "http://b2b-vault:8200"
      VAULT_TOKEN: "ROOT-TOKEN-DEV"
    volumes:
      - ./infra/secrets:/tmp/secrets
    networks:
      - b2b-network
    command: >
      sh -c "
        echo 'â³ Esperando a que Vault arranque...';
        sleep 5;
        echo 'ğŸ”“ Habilitando motor de secretos...';
        vault secrets enable -path=secret kv-v2 || true;
        echo 'ğŸ“¥ Cargando secretos...';
        vault kv put secret/common @/tmp/secrets/common-secrets.json;
        vault kv put secret/customer-service @/tmp/secrets/customer-service.json;
        echo 'âœ… Â¡ConfiguraciÃ³n completada!';
      "

networks:
  b2b-network:
    driver: bridge

volumes:
  postgres_data_b2b:
  mongo_data_b2b: